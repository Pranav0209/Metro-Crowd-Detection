<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Crowd Indicator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #2575fc;
            background-color: #f0f7ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a0cb0 0%, #1565e0 100%);
        }
        .result-image {
            width: 100%;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .density-indicator {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 50%;
        }
        .low-density {
            background-color: blue;
        }
        .medium-density {
            background-color: green;
        }
        .high-density {
            background-color: red;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .analysis-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 800px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .analysis-section h1, 
        .analysis-section h2, 
        .analysis-section h3 {
            color: #2575fc;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .analysis-section table {
            width: 100%;
            margin-bottom: 1.5rem;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .analysis-section table th,
        .analysis-section table td {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .analysis-section table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        
        .analysis-section table tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .analysis-section table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .analysis-section blockquote {
            border-left: 4px solid #2575fc;
            padding-left: 1rem;
            color: #6c757d;
            background-color: rgba(37, 117, 252, 0.05);
            padding: 1rem;
            border-radius: 0 4px 4px 0;
        }
        
        .analysis-section ul, 
        .analysis-section ol {
            padding-left: 1.5rem;
        }
        
        .analysis-section li {
            margin-bottom: 0.5rem;
        }
        
        .analysis-section p {
            margin-bottom: 1rem;
        }
        
        .analysis-section strong,
        .analysis-section b {
            color: #495057;
        }
        
        .analysis-section h4 {
            color: #6c757d;
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        .analysis-section hr {
            margin: 1.5rem 0;
            border-color: rgba(37, 117, 252, 0.2);
        }
        .bogie-card {
            transition: transform 0.3s;
        }
        .bogie-card:hover {
            transform: scale(1.02);
        }
        .train-diagram {
            margin: 10px 0;
        }
        
        .train-car {
            width: 30px;
            height: 20px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            margin: 0 2px;
            text-align: center;
            font-size: 12px;
            line-height: 20px;
            border-radius: 3px;
        }
        
        .active-car {
            background-color: #2575fc;
            color: white;
            font-weight: bold;
        }
        
        .bogie-image-container {
            position: relative;
            margin-bottom: 15px;
            max-height: 300px;
            overflow: hidden;
        }
        
        .bogie-image {
            width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 5px;
        }
        
        .bogie-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1><i class="fas fa-subway"></i> Metro Crowd Indicator</h1>
        <p>Upload images of metro bogies to analyze crowd distribution and get AI-powered recommendations</p>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Metro Bogie Images
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-upload upload-icon"></i>
                            <h4>Drag & Drop Images Here</h4>
                            <p>or</p>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            <button class="btn btn-primary" id="browseBtn">Browse Files</button>
                            <div id="fileList" class="mt-3"></div>
                        </div>
                         <!-- Add this right after the upload-area div -->
                         <div class="alert alert-info mt-3">
                             <i class="fas fa-info-circle"></i> <strong>How to use:</strong>
                             <ol>
                                 <li>Upload images of metro bogies using drag & drop or the browse button</li>
                                 <li>For each image, select which bogie it belongs to using the dropdown</li>
                                 <li>You can upload multiple images of the same bogie for more accurate analysis</li>
                                 <li>Click "Analyze Crowd Distribution" when ready</li>
                             </ol>
                         </div>
                         <div class="mt-4">
                            <h5><i class="fas fa-subway-station"></i> Platform Analysis</h5>
                            <p>Upload an image of the station platform to analyze crowd density and adjust train frequency</p>
                            <div class="input-group">
                                <input type="file" class="form-control" id="platformInput" accept="image/*">
                                <label class="input-group-text" for="platformInput">Upload Platform Image</label>
                            </div>
                            <div id="platformPreview" class="mt-2" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Platform image ready for analysis
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" id="analyzeBtn" disabled>
                                <i class="fas fa-chart-bar"></i> Analyze Crowd Distribution
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Processing images and analyzing crowd distribution...</p>
        </div>

        <div id="resultsSection" style="display: none;">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i> Summary Analysis
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <img id="summaryImage" class="img-fluid" alt="Summary Analysis">
                                </div>
                                <div class="col-md-4">
                                    <h5>Crowd Density Legend:</h5>
                                    <p><span class="density-indicator low-density"></span> Low Density (â‰¤5 people)</p>
                                    <p><span class="density-indicator medium-density"></span> Medium Density (6-10 people)</p>
                                    <p><span class="density-indicator high-density"></span> High Density (>10 people)</p>
                                    
                                    <h5 class="mt-4">Recommendations:</h5>
                                    <div id="recommendations" class="alert alert-info"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="mb-0"><i class="fas fa-brain"></i> AI-Enhanced Analysis (Groq LLM)</h4>
                                <span class="badge bg-light text-primary">Powered by Groq LLM</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="border-bottom pb-2 text-primary"><i class="fas fa-chart-bar"></i> Model Count Comparison:</h5>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th class="text-center">Bogie</th>
                                                    <th class="text-center">YOLO Count</th>
                                                    <th class="text-center">Density-Corrected Count</th>
                                                    <th class="text-center">Groq LLM Estimated Count</th>
                                                    <th class="text-center">Final Count</th>
                                                </tr>
                                            </thead>
                                            <tbody id="countComparisonTable">
                                                <!-- Will be populated by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <h5 class="border-bottom pb-2 text-primary"><i class="fas fa-lightbulb"></i> Groq LLM Detailed Analysis:</h5>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> This analysis provides AI-enhanced insights about passenger distribution and recommendations for crowd management.
                                    </div>
                                    <div id="groqAnalysis" class="analysis-section p-4 border rounded bg-light shadow-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-train"></i> Individual Bogie Analysis
                        </div>
                        <div class="card-body">
                            <div class="row" id="bogieResults">
                                <!-- Individual bogie results will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="platformResultsSection" style="display: none;">
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-subway-station"></i> Platform Analysis
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <img id="platformImage" class="img-fluid" alt="Platform Analysis">
                            </div>
                            <!-- Inside the platformResultsSection div, add this to display density score -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">Platform Details</div>
                                    <div class="card-body">
                                        <p><strong> Density Based People Count:</strong> <span id="platformPeopleCount"></span></p>
                                        <p><strong>YOLO Detection Count:</strong> <span id="platformYoloCount"></span></p>
                                        <p><strong>Density Score:</strong> <span id="platformDensityScore"></span></p>
                                        <p><strong>Density Level:</strong> <span id="platformDensity" class="badge rounded-pill"></span></p>
                                        <p><strong>Train Frequency:</strong> <span id="trainFrequency"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsSection = document.getElementById('resultsSection');
            const summaryImage = document.getElementById('summaryImage');
            const recommendations = document.getElementById('recommendations');
            const groqAnalysis = document.getElementById('groqAnalysis');
            const bogieResults = document.getElementById('bogieResults');
            const platformInput = document.getElementById('platformInput');
            const platformPreview = document.getElementById('platformPreview');
            const platformResultsSection = document.getElementById('platformResultsSection');
            const platformImage = document.getElementById('platformImage');
            const platformPeopleCount = document.getElementById('platformPeopleCount');
            const platformDensity = document.getElementById('platformDensity');
            const trainFrequency = document.getElementById('trainFrequency');
            
            let platformFile = null;
            
            let files = [];
            
            // Handle browse button click
            browseBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Handle file selection
            fileInput.addEventListener('change', function() {
                handleFiles(this.files);
            });
            
            // Handle drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#2575fc';
                uploadArea.style.backgroundColor = '#f0f7ff';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = '';
                handleFiles(e.dataTransfer.files);
            });
            
            // Handle files
            function handleFiles(selectedFiles) {
                files = Array.from(selectedFiles).filter(file => file.type.startsWith('image/'));
                
                if (files.length > 0) {
                    analyzeBtn.disabled = false;
                    displayFileList();
                } else {
                    analyzeBtn.disabled = true;
                }
            }
            
            // Display file list
            function displayFileList() {
                fileList.innerHTML = '';
                
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'alert alert-secondary d-flex justify-content-between align-items-center';
                    
                    // Create bogie selector dropdown
                    const bogieSelector = document.createElement('select');
                    bogieSelector.className = 'form-select form-select-sm bogie-selector';
                    bogieSelector.style.width = '120px';
                    bogieSelector.setAttribute('data-index', index);
                    
                    // Add options for 6 bogies
                    for (let i = 1; i <= 6; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Bogie ${i}`;
                        // Default to sequential assignment
                        if (i === (index % 6) + 1) {
                            option.selected = true;
                        }
                        bogieSelector.appendChild(option);
                    }
                    
                    // Create a container for the file info
                    const fileInfo = document.createElement('div');
                    fileInfo.innerHTML = `<i class="fas fa-file-image"></i> ${file.name}`;
                    
                    // Create a container for the controls
                    const controlsContainer = document.createElement('div');
                    controlsContainer.className = 'd-flex align-items-center';
                    
                    // Add the bogie selector
                    const selectorContainer = document.createElement('div');
                    selectorContainer.className = 'me-2';
                    selectorContainer.appendChild(document.createTextNode('Bogie: '));
                    selectorContainer.appendChild(bogieSelector);
                    controlsContainer.appendChild(selectorContainer);
                    
                    // Add the remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-danger remove-file';
                    removeBtn.setAttribute('data-index', index);
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    controlsContainer.appendChild(removeBtn);
                    
                    // Add the file info and controls to the file item
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(controlsContainer);
                    
                    fileList.appendChild(fileItem);
                });
                
                // Add remove file event listeners
                document.querySelectorAll('.remove-file').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        files.splice(index, 1);
                        displayFileList();
                        if (files.length === 0) {
                            analyzeBtn.disabled = true;
                        }
                    });
                });
            }
            
            // Handle platform image selection
            platformInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    platformFile = this.files[0];
                    platformPreview.style.display = 'block';
                } else {
                    platformFile = null;
                    platformPreview.style.display = 'none';
                }
            });
            
            // Handle analyze button click
            analyzeBtn.addEventListener('click', function() {
                if (files.length === 0) {
                    alert("Please select at least one file before analyzing.");
                    return;
                }
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                resultsSection.style.display = 'none';
                
                // Create form data
                const formData = new FormData();
                
                // Log for debugging
                console.log("Files to upload:", files.length, "files");
                
                // Add files with their bogie IDs
                files.forEach((file, index) => {
                    // Ensure file is a valid File object
                    if (file instanceof File) {
                        formData.append('files[]', file);
                        
                        // Get the selected bogie ID (1-6) for this file
                        const bogieSelector = document.querySelector(`.bogie-selector[data-index="${index}"]`);
                        const bogieId = bogieSelector ? bogieSelector.value : (index % 6) + 1;
                        formData.append('bogie_ids[]', bogieId);
                        
                        console.log(`Appending file: ${file.name}, size: ${file.size}, type: ${file.type}, bogie: ${bogieId}`);
                    } else {
                        console.error("Invalid file object:", file);
                    }
                });
                
                // Add platform image if available
                if (platformFile) {
                    formData.append('platform_image', platformFile);
                    console.log("Appending platform file:", platformFile.name);
                }
                
                // Log FormData entries (this is tricky but possible)
                console.log("FormData entries:");
                for (let pair of formData.entries()) {
                    console.log(pair[0], pair[1] instanceof File ? `${pair[1].name} (${pair[1].size} bytes)` : pair[1]);
                }
                
                // Send request to server
                fetch('/analyze', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                    
                    if (data.error) {
                        console.error("Server error:", data.error);
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    // Function to display results
                    function displayResults(data) {
                        // Show results section
                        resultsSection.style.display = 'block';
                        
                        // Display summary image
                        summaryImage.src = '/static/results/' + data.summary_image.split('/').pop();
                        
                        // Display recommendations
                        recommendations.textContent = data.recommendations;
                        
                        // Display Groq analysis with markdown formatting
                        if (data.groq_analysis) {
                            try {
                                // Parse the markdown content
                                const parsedContent = marked.parse(data.groq_analysis);
                                groqAnalysis.innerHTML = parsedContent;
                                
                                // Apply additional styling to tables
                                const tables = groqAnalysis.querySelectorAll('table');
                                tables.forEach(table => {
                                    table.classList.add('table', 'table-bordered', 'table-hover', 'table-striped', 'mb-4');
                                    
                                    // Add Bootstrap classes to table headers
                                    const headers = table.querySelectorAll('th');
                                    headers.forEach(header => {
                                        header.classList.add('bg-light');
                                    });
                                });
                                
                                // Apply styling to headings
                                const headings = groqAnalysis.querySelectorAll('h1, h2, h3, h4, h5, h6');
                                headings.forEach(heading => {
                                    heading.classList.add('mt-4', 'mb-3');
                                    
                                    // Add different styling based on heading level
                                    if (heading.tagName === 'H2') {
                                        heading.classList.add('text-primary', 'border-bottom', 'pb-2');
                                    } else if (heading.tagName === 'H3') {
                                        heading.classList.add('text-secondary');
                                    }
                                });
                                
                                // Style lists
                                const lists = groqAnalysis.querySelectorAll('ul, ol');
                                lists.forEach(list => {
                                    list.classList.add('mb-3');
                                });
                                
                                // Style blockquotes
                                const blockquotes = groqAnalysis.querySelectorAll('blockquote');
                                blockquotes.forEach(quote => {
                                    quote.classList.add('border-start', 'border-4', 'border-primary', 'ps-3', 'py-2', 'bg-light');
                                });
                            } catch (e) {
                                console.error("Error parsing markdown:", e);
                                groqAnalysis.innerHTML = '<div class="alert alert-warning">Error formatting analysis. Raw content:</div>' + 
                                                        '<pre class="bg-light p-3">' + data.groq_analysis + '</pre>';
                            }
                        } else {
                            groqAnalysis.innerHTML = '<div class="alert alert-info">No enhanced analysis available.</div>';
                        }
                        
                        // Populate count comparison table
                        const countComparisonTable = document.getElementById('countComparisonTable');
                        countComparisonTable.innerHTML = '';
                        
                        if (data.counts && data.yolo_counts && data.density_counts && data.groq_counts) {
                            for (let i = 0; i < data.counts.length; i++) {
                                const row = document.createElement('tr');
                                
                                // Determine row color based on crowd level
                                let rowClass = '';
                                if (data.counts[i] > 30) {
                                    rowClass = 'table-danger';
                                } else if (data.counts[i] > 15) {
                                    rowClass = 'table-warning';
                                } else {
                                    rowClass = 'table-success';
                                }
                                row.className = rowClass;
                                
                                // Create cells
                                row.innerHTML = `
                                    <td class="text-center"><strong>Bogie ${i+1}</strong></td>
                                    <td class="text-center">${data.yolo_counts[i]}</td>
                                    <td class="text-center">${data.density_counts[i]}</td>
                                    <td class="text-center">${data.groq_counts[i]}</td>
                                    <td class="text-center"><strong>${data.counts[i]}</strong></td>
                                `;
                                
                                countComparisonTable.appendChild(row);
                            }
                        }
                        
                        // Display platform results if available
                        if (data.platform_data) {
                            platformResultsSection.style.display = 'block';
                            platformImage.src = '/static/results/' + data.platform_data.processed_image.split('/').pop();
                            platformPeopleCount.textContent = data.platform_data.total_people;
                            platformYoloCount.textContent = data.platform_data.yolo_count;
                            platformDensityScore.textContent = data.platform_data.density_score.toFixed(2);
                            
                            // Set density badge color
                            platformDensity.textContent = data.platform_data.density_level.charAt(0).toUpperCase() + 
                                                                data.platform_data.density_level.slice(1);
                            
                            if (data.platform_data.density_level === 'low') {
                                platformDensity.className = 'badge bg-primary rounded-pill';
                            } else if (data.platform_data.density_level === 'medium') {
                                platformDensity.className = 'badge bg-warning rounded-pill';
                            } else {
                                platformDensity.className = 'badge bg-danger rounded-pill';
                            }
                            
                            // Set train frequency
                            trainFrequency.textContent = 'Every ' + data.platform_data.train_frequency + ' min';
                        }
                        else {
                            platformResultsSection.style.display = 'none';
                        }
                        
                        // Display individual bogie results
                        bogieResults.innerHTML = '';
                        
                        // Group images by bogie ID
                        const bogieGroups = {};
                        
                        // Log the processed images for debugging
                        console.log("Processed images:", data.processed_images);
                        
                        // Extract bogie ID from image path
                        data.processed_images.forEach((imagePath, index) => {
                            const count = data.counts[index];
                            const yoloCount = data.yolo_counts ? data.yolo_counts[index] : count;
                            const densityCount = data.density_counts ? data.density_counts[index] : count;
                            const groqCount = data.groq_counts ? data.groq_counts[index] : count;
                            
                            // Extract posture data if available
                            const standingCount = data.standing_counts ? data.standing_counts[index] : undefined;
                            const sittingCount = data.sitting_counts ? data.sitting_counts[index] : undefined;
                            const adjustedSittingCount = data.adjusted_sitting_counts ? data.adjusted_sitting_counts[index] : sittingCount;
                            const allSeatsOccupied = data.all_seats_occupied_flags ? data.all_seats_occupied_flags[index] : false;
                            
                            // Extract bogie ID from the filename
                            let bogieId = index + 1; // Default fallback
                            
                            // Try to extract bogie ID from filename (e.g., bogie_1_combined_...)
                            const filename = imagePath.split('/').pop();
                            const match = filename.match(/bogie_(\d+)/i);
                            if (match && match[1]) {
                                bogieId = parseInt(match[1]);
                                console.log(`Extracted bogie ID ${bogieId} from filename ${filename}`);
                            }
                            
                            // Log each image path for debugging
                            console.log(`Bogie ${bogieId} image path:`, imagePath);
                            
                            if (!bogieGroups[bogieId]) {
                                bogieGroups[bogieId] = {
                                    images: [],
                                    count: count,
                                    yoloCount: yoloCount,
                                    densityCount: densityCount,
                                    groqCount: groqCount,
                                    standingCount: standingCount,
                                    sittingCount: sittingCount,
                                    adjustedSittingCount: adjustedSittingCount,
                                    allSeatsOccupied: allSeatsOccupied
                                };
                            }
                            
                            bogieGroups[bogieId].images.push(imagePath);
                        });
                        
                        // Create cards for each bogie group
                        Object.keys(bogieGroups).forEach(bogieId => {
                            const group = bogieGroups[bogieId];
                            const count = group.count;
                            const yoloCount = group.yoloCount;
                            const densityCount = group.densityCount;
                            const groqCount = group.groqCount;
                            const standingCount = group.standingCount;
                            const sittingCount = group.sittingCount;
                            const adjustedSittingCount = group.adjustedSittingCount;
                            const allSeatsOccupied = group.allSeatsOccupied;
                            
                            let densityClass = 'low-density';
                            let densityText = 'Low Density';
                            
                            if (count > 10) {
                                densityClass = 'high-density';
                                densityText = 'High Density';
                            } else if (count > 5) {
                                densityClass = 'medium-density';
                                densityText = 'Medium Density';
                            }
                            
                            const bogieCard = document.createElement('div');
                            bogieCard.className = 'col-md-6 mb-4';
                            bogieCard.innerHTML = `
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5>Bogie ${bogieId}</h5>
                                            <span class="density-indicator ${densityClass}" title="${densityText}"></span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="bogie-image-container mb-3">
                                            <img src="/static/results/${group.images[0].split('/').pop()}" class="bogie-image" alt="Bogie ${bogieId}">
                                        </div>
                                        
                                        <div class="count-comparison">
                                            <h6>Passenger Count Comparison:</h6>
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Method</th>
                                                        <th>Count</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>YOLO</td>
                                                        <td>${yoloCount}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Density</td>
                                                        <td>${densityCount}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Groq LLM</td>
                                                        <td>${groqCount}</td>
                                                    </tr>
                                                    ${standingCount !== undefined && sittingCount !== undefined ? `
                                                    <tr class="table-info">
                                                        <td>Standing</td>
                                                        <td>${standingCount}</td>
                                                    </tr>
                                                    <tr class="table-info">
                                                        <td>Sitting</td>
                                                        <td>${sittingCount}</td>
                                                    </tr>
                                                    ${allSeatsOccupied ? `
                                                    <tr class="table-warning">
                                                        <td>Adjusted Sitting (All Seats)</td>
                                                        <td>${adjustedSittingCount}</td>
                                                    </tr>
                                                    <tr class="table-success">
                                                        <td><strong>Total with Adjustment</strong></td>
                                                        <td><strong>${standingCount + adjustedSittingCount}</strong></td>
                                                    </tr>
                                                    ` : ''}
                                                    ` : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="bogie-position mt-3">
                                            <h6>Position in Train:</h6>
                                            <div class="train-diagram">
                                                ${createTrainDiagram(bogieId, 6)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            bogieResults.appendChild(bogieCard);
                        });
                    }
                    
                    // Helper function to create a visual train diagram
                    function createTrainDiagram(activeBogieId, totalBogies) {
                        let html = '<div class="d-flex justify-content-center">';
                        
                        for (let i = 1; i <= totalBogies; i++) {
                            const isActive = i === parseInt(activeBogieId);
                            html += `<div class="train-car ${isActive ? 'active-car' : ''}" title="Bogie ${i}">${i}</div>`;
                        }
                        
                        html += '</div>';
                        return html;
                    }
                    
                    // Call displayResults with the data
                    displayResults(data);
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    console.error("Fetch error:", error);
                    alert('Error: ' + error.message);
                });
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Configure marked.js to handle tables
        marked.use({
            gfm: true,
            breaks: true,
            tables: true
        });
    </script>
</body>
</html>